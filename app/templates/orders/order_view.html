{# file_path: crm_flask/app/templates/orders/order_view.html #}
{% extends 'main/base.html' %}

{% block title %}Детали заявки{% endblock %}

{% block styles %}
<link href="{{ url_for('static', filename='dist/css/custom/orders/order_view.css') }}" rel="stylesheet"/>
{% endblock %}

{% block script %}
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<!-- Bootstrap JS -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
<!-- Кастомный скрипт для логики на странице заявки (с задачами) -->
<script src="{{ url_for('static', filename='dist/js/custom/orders/order_view.js') }}"></script>
{% endblock %}

{% block content %}
<div class="container">
    <div class="card shadow mb-4">
        <div class="card-header">
            <div class="row align-items-center">
                <!-- Левая колонка: ID заявки -->
                <div class="col-md-4 text-left">
                    <h4 class="mb-0">
                        Заявка №{{ order.id }}
                    </h4>
                </div>

                <!-- Центральная колонка: Статус заявки -->
                <div class="col-md-4 text-center">
                    <button type="button"
                            class="btn btn-block btn-{{ order.status.bootstrap_class }} btn-status"
                            title="{{ order.status.name }}"
                            data-toggle="modal"
                            data-target="#changeStatusModal">
                        {{ order.status.name_geo }}
                    </button>
                </div>

                <!-- Модальное окно изменения статуса заявки -->
                <div class="modal fade" id="changeStatusModal" tabindex="-1" role="dialog"
                     aria-labelledby="changeStatusModalLabel" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <form id="changeStatusForm"
                              action="{{ url_for('orders.update_order_status', order_id=order.id) }}"
                              method="POST">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Обновить статус</h5>
                                    <button type="button" class="close" data-dismiss="modal"
                                            aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <!-- Выбор статуса -->
                                    <div class="form-group">
                                        <label for="newStatus">Новый статус:</label>
                                        <select id="newStatus" name="new_status" class="form-control" required>
                                            {% for status in all_statuses %}
                                                <option value="{{ status.id }}"
                                                        {% if status.id == order.status_id %}selected{% endif %}>
                                                    {{ status.name_geo }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button"
                                            class="btn btn-secondary"
                                            data-dismiss="modal">
                                        Отмена
                                    </button>
                                    <button type="submit" class="btn btn-primary">Сохранить</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Правая колонка: информация об аккаунте -->
                <div class="col-md-4 text-right">
                    {% if order.customer_account %}
                        <div class="d-flex align-items-center justify-content-end">
                            <span class="me-2 mr-2">Аккаунт:</span>
                            <a href="{{ url_for('customer_accounts.view_customer_account',
                                                account_id=order.customer_account.id) }}"
                               class="btn btn-success btn-sm d-flex align-items-center me-2"
                               target="_blank"
                               data-toggle="tooltip"
                               data-placement="top"
                               title="Просмотр аккаунта">
                                {{ order.customer_account.account_pay_number }}
                            </a>
                            <button type="button"
                                    class="btn btn-secondary btn-sm"
                                    data-toggle="tooltip"
                                    data-placement="top"
                                    title="Копировать PayID"
                                    onclick="copyPayID(this, '{{ order.customer_account.account_pay_number }}')">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    {% else %}
                        <span class="badge bg-warning">Аккаунт не создан</span>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Тело карточки с детальной информацией -->
        <div class="card-body">
            <div class="row mb-4">
                <div class="col-lg-6 col-md-12 mb-4">
                    <div class="card h-100">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="fas fa-user"></i> Информация о клиенте</h5>
                        </div>
                        <div class="card-body p-3">
                            <div class="table-responsive">
                                <table class="table table-borderless mb-0">
                                    <tbody>
                                    <tr>
                                        <td class="text-muted">Тип клиента:</td>
                                        <td>{{ order.customer.customer_type.name }}</td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted">{{ 'П/Н' if order.customer.customer_type.id == 1 else 'С/К' }}:</td>
                                        <td>{{ order.customer.identification_number or 'Не указано' }}</td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted">Имя:</td>
                                        <td>{{ order.customer.name }}</td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted">Email:</td>
                                        <td>{{ order.customer.email or 'Не указано' }}</td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted">Резидент:</td>
                                        <td>{{ 'Да' if order.customer.resident else 'Нет' }}</td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted">Мобильный:</td>
                                        <td>{{ order.customer.mobile or 'Не указано' }}</td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted">Доп. контакт:</td>
                                        <td>{{ order.customer.mobile_second or 'Не указано' }}</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6 col-md-12 mb-4">
                    <div class="card h-100">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="fas fa-info-circle"></i> Информация о заказе</h5>
                        </div>
                        <div class="card-body p-3">
                            <div class="table-responsive">
                                <table class="table table-borderless mb-0">
                                    <tbody>
                                    <tr>
                                        <td class="text-muted">Тариф:</td>
                                        <td>{{ order.tariff_plan.name if order.tariff_plan else 'Не указано' }}</td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted">Комментарий:</td>
                                        <td class="text-break">{{ order.comment or 'Нет комментария' }}</td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted">Создано:</td>
                                        <td>{{ order.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted">Обновлено:</td>
                                        <td>{{ order.updated_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Адрес -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-map-marker-alt"></i> Адрес</h5>
                </div>
                <div class="card-body p-3">
                    <div class="table-responsive">
                        <table class="table table-borderless mb-0">
                            <tbody>
                            <tr>
                                <td class="text-muted">Район:</td>
                                <td>{{ order.address.district.name if order.address.district else 'Не указано' }}</td>
                            </tr>
                            <tr>
                                <td class="text-muted">Населённый пункт:</td>
                                <td>{{ order.address.settlement.name if order.address.settlement and order.address.settlement.name else 'Не указано' }}</td>
                            </tr>
                            <tr>
                                <td class="text-muted">Юр. адрес:</td>
                                <td>{{ order.address.legal_address or 'Не указано' }}</td>
                            </tr>
                            <tr>
                                <td class="text-muted">Факт. адрес:</td>
                                <td>{{ order.address.actual_address or 'Не указано' }}</td>
                            </tr>
                            <tr>
                                <td class="text-muted">Координаты:</td>
                                <td>
                                    {{ order.address.coordinates.latitude if order.address and order.address.coordinates else '---' }},
                                    {{ order.address.coordinates.longitude if order.address and order.address.coordinates else '---' }}
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Связанные задачи -->
            <div class="card shadow mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-tasks"></i> Связанные задачи</h5>
                </div>
                <div class="card-body p-2">
                    {% if related_tasks %}
                        <!-- Таблица (desktop) -->
                        <div class="d-none d-md-block table-responsive">
                            <table class="table table-striped table-sm">
                                <thead>
                                <tr>
                                    <th class="d-none d-md-table-cell">ID</th>
                                    <th>Дивизион</th>
                                    <th>Тип задачи</th>
                                    <th>Статус</th>
                                    <th>Описание</th>
                                    <th class="d-none d-md-table-cell">Создатель</th>
                                    <th class="d-none d-md-table-cell">Дата</th>
                                    <th>Действие</th>
                                </tr>
                                </thead>
                                <tbody id="tasksTableBody">
                                {% for task in related_tasks %}
                                    <tr id="task-row-{{ task.id }}">
                                        <td class="d-none d-md-table-cell">{{ task.id }}</td>
                                        <td>{{ task.task_type.division.name if task.task_type and task.task_type.division else '' }}</td>
                                        <td>{{ task.task_type.name if task.task_type else '' }}</td>
                                        <td>
                                            <span class="badge bg-{{ task.status.bootstrap_class }} text-capitalize"
                                                  id="task-status-{{ task.id }}">
                                                {{ task.status.name }}
                                            </span>
                                        </td>
                                        <td class="text-truncate" style="max-width: 150px;"
                                            title="{{ task.description }}">
                                            {{ task.description }}
                                        </td>
                                        <td class="d-none d-md-table-cell">
                                            {{ task.created_user.name if task.created_user else 'Неизвестно' }}
                                        </td>
                                        <td class="d-none d-md-table-cell">
                                            {{ task.created_at.strftime('%d-%m-%Y') }}
                                        </td>
                                        <td class="text-center">
                                            <div class="btn-group btn-group-sm" role="group" aria-label="Actions">
                                                <button class="btn btn-primary"
                                                        title="Посмотреть"
                                                        data-toggle="modal"
                                                        data-target="#taskModal"
                                                        onclick="showTaskDetails({{ task.id }})">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Карточки (mobile) -->
                        <div class="d-block d-md-none">
                            {% for task in related_tasks %}
                                <div class="card task-card">
                                    <div class="card-body">
                                        <h6><strong>Тип задачи:</strong> {{ task.task_type.name if task.task_type else '' }}</h6>
                                        <h6><strong>Статус:</strong>
                                            <span class="badge bg-{{ task.status.bootstrap_class }} text-capitalize">
                                                {{ task.status.name }}
                                            </span>
                                        </h6>
                                        <p class="text-truncate" title="{{ task.description }}">
                                            <strong>Описание:</strong> {{ task.description }}
                                        </p>
                                        <div class="btn-group btn-group-sm" role="group" aria-label="Actions">
                                            <button class="btn btn-primary"
                                                    title="Посмотреть"
                                                    data-toggle="modal"
                                                    data-target="#taskModal"
                                                    onclick="showTaskDetails({{ task.id }})">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted">Нет связанных задач.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Toast-уведомления -->
            <div class="toast" id="successToast" data-delay="3000" style="position: fixed; top: 20px; right: 20px;">
                <div class="toast-header bg-success text-white">
                    <strong class="mr-auto">Успех</strong>
                    <button type="button" class="ml-2 mb-1 close text-white" data-dismiss="toast">&times;</button>
                </div>
                <div class="toast-body">
                    Операция успешно выполнена.
                </div>
            </div>

            <div class="toast" id="errorToast" data-delay="3000" style="position: fixed; top: 20px; right: 20px;">
                <div class="toast-header bg-danger text-white">
                    <strong class="mr-auto">Ошибка</strong>
                    <button type="button" class="ml-2 mb-1 close text-white" data-dismiss="toast">&times;</button>
                </div>
                <div class="toast-body" id="errorToastBody">
                    Произошла ошибка. Попробуйте позже.
                </div>
            </div>

        </div>

<!-- Модальное окно задачи (просмотр/редактирование) -->
<div class="modal fade" id="taskModal" tabindex="-1" role="dialog"
     aria-labelledby="taskModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <form id="taskEditForm" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" id="actionType" name="action_type" value="update_status">
            <input type="hidden" id="order_id" name="order_id" value="{{ order.id }}">
            <div class="modal-content">
                <!-- Заголовок модального окна -->
                <div class="modal-header">
                    <h5 class="modal-title" id="taskModalLabel">Детали задачи</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <!-- Тело модального окна -->
                <div class="modal-body">
                    <!-- Идёт загрузка -->
                    <div id="loadingSpinner" class="text-center my-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                    </div>

                    <!-- Ошибка загрузки -->
                    <div id="errorMessage" class="alert alert-danger" role="alert"
                         style="display: none;">
                        Ошибка при загрузке данных. Попробуйте позже.
                    </div>

                    <!-- Контент задачи -->
                    <div id="taskDetailsContent" style="display: none;">

                        <!-- Блок с основной информацией о задаче -->
                        <div class="task-details">
                            <div class="task-detail">
                                <strong>ID задачи:</strong>
                                <span id="parentTaskID"></span>
                            </div>

                            <!-- Новые поля для названия типа задачи и подразделения -->
                            <div class="task-detail">
                                <strong>Подразделение (название):</strong>
                                <span id="parentTaskDivisionName"></span>
                            </div>
                            <div class="task-detail">
                                <strong>Тип задачи (название):</strong>
                                <span id="parentTaskTypeName"></span>
                            </div>

                            <!-- Оставляем ID типа задачи при необходимости -->
                            <div class="task-detail d-none">
                                <strong>Тип задачи (ID):</strong>
                                <span id="parentTaskTypeID"></span>
                            </div>

                            <!-- Новое поле для названия статуса -->
                            <div class="task-detail">
                                <strong>Статус задачи:</strong>
                                <span id="parentTaskStatusName"></span>
                            </div>

                            <!-- Существующее поле для ID статуса -->
                            <div class="task-detail d-none">
                                <strong>Текущий статус (ID):</strong>
                                <span id="parentTaskStatusID"></span>
                            </div>
                        </div>

                        <!-- Описание задачи -->
                        <div class="form-group">
                            <label for="taskDescription"><strong>Описание:</strong></label>
                            <textarea id="taskDescription"
                                      class="form-control"
                                      rows="4"
                                      readonly></textarea>
                        </div>

                        <!-- Селект изменения статуса -->
                        <div class="form-group">
                            <label for="parentTaskStatusChangeID"><strong>Изменить статус:</strong></label>
                            <select id="parentTaskStatusChangeID"
                                    class="form-control"
                                    name="status"
                                    required>
                                <!-- Опции добавляются динамически -->
                            </select>
                        </div>

                        <!-- Поле MAC-адреса -->
                        <div class="form-group" id="macAddressContainer" style="display: none;">
                            <label for="macAddressInput"><strong>MAC-адрес:</strong></label>
                            <input type="text"
                                   id="macAddressInput"
                                   name="mac_address"
                                   class="form-control"
                                   placeholder="XX:XX:XX:XX:XX:XX">
                            <small class="form-text text-muted">
                                Формат: XX:XX:XX:XX:XX:XX (шестнадцатеричные символы).
                            </small>
                        </div>

                        <!-- Кнопка "плюс" для создания подзадачи -->
                        <button type="button"
                                id="subTaskCreate"
                                class="btn btn-success mb-3"
                                style="display: none;">
                            <i class="fas fa-plus"></i>
                        </button>

                        <!-- Выбор дивизиона подзадачи -->
                        <div class="form-group" id="subTaskDivisionContainer" style="display: none;">
                            <label for="subTaskDivisionId"><strong>Дивизион:</strong></label>
                            <select id="subTaskDivisionId"
                                    class="form-control">
                                <option value="" disabled selected>Выберите дивизион</option>
                                <!-- Опции добавляются динамически -->
                            </select>
                        </div>

                        <!-- Выбор типа подзадачи -->
                        <div class="form-group" id="subTaskTypeContainer" style="display: none;">
                            <label for="subTaskTypeId"><strong>Тип задачи:</strong></label>
                            <select id="subTaskTypeId"
                                    class="form-control"
                                    name="task_type">
                                <option value="" disabled selected>Выберите тип задачи</option>
                                <!-- Опции добавляются динамически -->
                            </select>
                        </div>

                        <!-- Описание подзадачи -->
                        <div class="form-group" id="subTaskDescriptionContainer" style="display: none;">
                            <label for="subTaskDescriptionID"><strong>Описание подзадачи:</strong></label>
                            <textarea id="subTaskDescriptionID"
                                      class="form-control"
                                      rows="4"
                                      placeholder="Введите описание подзадачи..."></textarea>
                        </div>

                    </div> <!-- #taskDetailsContent -->
                </div>

                <!-- Футер модального окна -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times"></i> Закрыть
                    </button>
                    <button type="submit" class="btn btn-primary" id="submitTaskButton">
                        <i class="fas fa-save"></i> Сохранить
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

    </div>
</div>

{% endblock %}
