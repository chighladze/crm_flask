<!-- crm_flask/app/templates/orders/order_list.html -->
{% extends 'main/base.html' %}

{% block title %}ლაშეტის სია{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h3 class="card-title">შეკვეთების სია</h3>
    </div>
    <div class="card-body">
        <!-- Filter Form -->
        <form id="filter-form" class="mb-4">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="search">ძიება</label>
                    <input type="text" id="search" name="search" class="form-control" placeholder="სახელი ან მობილური ნომერი">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="identification_number">პერსონალური ნომერი</label>
                    <input type="text" id="identification_number" name="identification_number" class="form-control" placeholder="პერსონალური ნომერი">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="mobile">მობილური ტელეფონი</label>
                    <input type="text" id="mobile" name="mobile" class="form-control" placeholder="მობილური ტელეფონი">
                </div>
            </div>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="tariff_plan_id">სატარიფო გეგმა</label>
                    <select id="tariff_plan_id" name="tariff_plan_id" class="form-control">
                        <option value="">ყველა</option>
                        {% for plan in tariff_plans %}
                            <option value="{{ plan.id }}">{{ plan.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <label for="start_date">დაწყების თარიღი</label>
                    <input type="date" id="start_date" name="start_date" class="form-control">
                </div>
                <div class="col-md-3 mb-3">
                    <label for="end_date">დამთავრების თარიღი</label>
                    <input type="date" id="end_date" name="end_date" class="form-control">
                </div>
                <div class="col-md-2 mb-3 align-self-end">
                    <button type="submit" class="btn btn-primary w-100">ფილტრაცია</button>
                </div>
            </div>
        </form>

        <!-- Orders Table -->
        <div id="orders-table-container">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>კლიენტი</th>
                        <th>პერსონალური ნომერი</th>
                        <th>მობილური</th>
                        <th>გადამოსხმელი მობილური</th>
                        <th>სატარიფო გეგმა</th>
                        <th>დაწყების თარიღი</th>
                        <th>განახლების თარიღი</th>
                        <th>კომენტარი</th>
                        <th>მოქმედება</th>
                    </tr>
                </thead>
                <tbody id="orders-table-body">
                    <!-- Orders will be populated here via JavaScript -->
                </tbody>
            </table>
            <!-- Pagination Controls -->
            <nav>
                <ul class="pagination" id="pagination">
                    <!-- Pagination buttons will be populated here via JavaScript -->
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- JavaScript for handling filters and AJAX requests -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const filterForm = document.getElementById('filter-form');
        const ordersTableBody = document.getElementById('orders-table-body');
        const paginationContainer = document.getElementById('pagination');

        // Load saved filters from localStorage
        const savedFilters = JSON.parse(localStorage.getItem('orders_filters')) || {};

        // Populate the filter form with saved filters
        for (const key in savedFilters) {
            const field = document.querySelector(`[name="${key}"]`);
            if (field) {
                field.value = savedFilters[key];
            }
        }

        // Function to fetch and display orders
        function fetchOrders(page = 1) {
            // Get current filter values
            const formData = new FormData(filterForm);
            const params = new URLSearchParams();
            formData.forEach((value, key) => {
                if (value) {
                    params.append(key, value);
                }
            });
            params.append('page', page);
            params.append('per_page', 10);

            // Fetch orders via API
            fetch(`/api/orders_list?${params.toString()}`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                // Populate the orders table
                ordersTableBody.innerHTML = '';
                data.orders.forEach(order => {
                    const row = document.createElement('tr');

                    row.innerHTML = `
                        <td>${order.ID}</td>
                        <td>${order.Customer}</td>
                        <td>${order["Identification Number"]}</td>
                        <td>${order.Mobile}</td>
                        <td>${order["Alt Mobile"] || 'N/A'}</td>
                        <td>${order["Tariff Plan"]}</td>
                        <td>${order["Created At"]}</td>
                        <td>${order["Updated At"]}</td>
                        <td>${order.Comment || 'N/A'}</td>
                        <td>
                            <a href="/orders/${order.ID}/view" class="btn btn-sm btn-info">ნახვა</a>
                            <a href="/orders/${order.ID}/edit" class="btn btn-sm btn-warning">რედაქტირება</a>
                        </td>
                    `;
                    ordersTableBody.appendChild(row);
                });

                // Handle pagination
                const pagination = data.pagination;
                paginationContainer.innerHTML = '';

                // Previous Button
                const prevLi = document.createElement('li');
                prevLi.classList.add('page-item', pagination.has_prev ? '' : 'disabled');
                prevLi.innerHTML = `<a class="page-link" href="#" data-page="${pagination.current_page - 1}">უკან</a>`;
                paginationContainer.appendChild(prevLi);

                // Page Numbers
                for (let i = 1; i <= pagination.pages; i++) {
                    const li = document.createElement('li');
                    li.classList.add('page-item', i === pagination.current_page ? 'active' : '');
                    li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
                    paginationContainer.appendChild(li);
                }

                // Next Button
                const nextLi = document.createElement('li');
                nextLi.classList.add('page-item', pagination.has_next ? '' : 'disabled');
                nextLi.innerHTML = `<a class="page-link" href="#" data-page="${pagination.current_page + 1}">წინ</a>`;
                paginationContainer.appendChild(nextLi);
            })
            .catch(error => {
                console.error('Error fetching orders:', error);
            });
        }

        // Initial fetch with saved filters
        fetchOrders(savedFilters.page || 1);

        // Handle filter form submission
        filterForm.addEventListener('submit', function(event) {
            event.preventDefault();

            // Save filters to localStorage
            const formData = new FormData(filterForm);
            const filters = {};
            formData.forEach((value, key) => {
                filters[key] = value;
            });
            filters.page = 1; // Reset to first page on new filter
            localStorage.setItem('orders_filters', JSON.stringify(filters));

            // Fetch orders with new filters
            fetchOrders(1);
        });

        // Handle pagination click
        paginationContainer.addEventListener('click', function(event) {
            event.preventDefault();
            const target = event.target;
            if (target.tagName === 'A') {
                const page = parseInt(target.getAttribute('data-page'));
                if (!isNaN(page)) {
                    // Update the page in localStorage
                    const filters = JSON.parse(localStorage.getItem('orders_filters')) || {};
                    filters.page = page;
                    localStorage.setItem('orders_filters', JSON.stringify(filters));

                    // Fetch orders for the selected page
                    fetchOrders(page);
                }
            }
        });

        // Optional: Clear filters button
        /*
        const clearFiltersBtn = document.getElementById('clear-filters');
        if (clearFiltersBtn) {
            clearFiltersBtn.addEventListener('click', function() {
                localStorage.removeItem('orders_filters');
                filterForm.reset();
                fetchOrders(1);
            });
        }
        */
    });
</script>
{% endblock %}
