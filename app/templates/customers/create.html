{% extends "main/base.html" %}

{% block title %}ახალი განაცხადი{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active">ახალი განაცხადი</li>
{% endblock %}

{% block styles %}
<link rel="icon" href="{{ url_for('static', filename='dist/css/custom/customers/create.css') }}" type="image/x-icon">
<link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet" />
{% endblock %}

{% block script %}
<script src="{{ url_for('static', filename='dist/js/custom/customers/create.js') }}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>
<script>
// English comment: Adjust column classes and director field visibility based on customer type.
document.addEventListener("DOMContentLoaded", function () {
    const customerTypeSelect = document.getElementById('customer-type');
    const idNumberContainer = document.getElementById('id-number-container');
    const nameContainer = document.getElementById('name-container');
    const directorContainer = document.getElementById('director-container');
    const typeCol = document.getElementById('type-col');

    function updateFields() {
        const type = customerTypeSelect.value;
        idNumberContainer.innerHTML = '';
        nameContainer.innerHTML = '';

        if (type === '1') {
            // Individual fields
            typeCol.className = 'col-md-4 form-group';
            idNumberContainer.className = 'col-md-4 form-group';
            nameContainer.className = 'col-md-4 form-group';

            const individualFieldsHtml = `
                <label>პირადი ნომერი</label>
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text"><i class="fas fa-address-card"></i></span>
                    </div>
                    <input class="form-control" id="identification_number" name="identification_number" required type="text" maxlength="50">
                </div>
            `;
            idNumberContainer.insertAdjacentHTML('beforeend', individualFieldsHtml);

            const individualNameHtml = `
                <label>სახელი და გვარი</label>
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text"><i class="fas fa-user"></i></span>
                    </div>
                    <input class="form-control" id="name" name="name" required type="text" maxlength="255">
                </div>
            `;
            nameContainer.insertAdjacentHTML('beforeend', individualNameHtml);

            directorContainer.style.display = 'none'; // Hide director field for individuals
        } else {
            // Company fields
            // 4 fields per row, each col-md-3
            typeCol.className = 'col-md-3 form-group';
            idNumberContainer.className = 'col-md-3 form-group';
            nameContainer.className = 'col-md-3 form-group';
            directorContainer.className = 'col-md-3 form-group';

            const companyIdHtml = `
                <label>საიდენტიფიკაციო კოდი</label>
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text"><i class="fas fa-address-card"></i></span>
                    </div>
                    <input class="form-control" id="identification_number" name="identification_number" required type="text" maxlength="50">
                </div>
                {% if customer_form.identification_number.errors %}
                <div class="text-danger">
                    {% for error in customer_form.identification_number.errors %}
                        <p>{{ error }}</p>
                    {% endfor %}
                </div>
                {% endif %}
            `;
            idNumberContainer.insertAdjacentHTML('beforeend', companyIdHtml);

            const companyNameHtml = `
                <label>კომპანიის სახელი</label>
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text"><i class="fas fa-home"></i></span>
                    </div>
                    <input class="form-control" id="name" name="name" required type="text" maxlength="255">
                </div>
                {% if customer_form.name.errors %}
                <div class="text-danger">
                    {% for error in customer_form.name.errors %}
                        <p>{{ error }}</p>
                    {% endfor %}
                </div>
                {% endif %}
            `;
            nameContainer.insertAdjacentHTML('beforeend', companyNameHtml);

            directorContainer.style.display = 'block'; // Show director for company
        }
    }

    customerTypeSelect.addEventListener('change', updateFields);
    updateFields();

    document.getElementById('customer-form').addEventListener('submit', function (e) {
        if (!document.getElementById('settlement-select').value) {
            e.preventDefault();
            alert('გთხოვთ აირჩიოთ დასახლება');
        }
    });
});
</script>
{% endblock %}

{% block content %}
<form method="POST" id="customer-form" novalidate>
    {{ customer_form.hidden_tag() }}
    {{ order_form.hidden_tag() }}
    <input type="hidden" name="create_order" id="create-order-flag" value="false">
    <input type="hidden" id="readonly_fields" value="{{ readonly_fields }}">

    <div class="card">
        <div class="card-header">
            <h3 class="card-title">ახალი განაცხადი</h3>
        </div>
        <div class="card-body">
            <!-- Row 1: Type, ID Number, Name, Director -->
            <div class="form-row">
                <div id="type-col" class="col-md-4 form-group">
                    <label>კლიენტის ტიპი</label>
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text"><i class="fas fa-id-badge"></i></span>
                        </div>
                        {{ customer_form.type_id(class="form-control", id="customer-type") }}
                    </div>
                    {% if customer_form.type_id.errors %}
                    <div class="text-danger">
                        {% for error in customer_form.type_id.errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                <div id="id-number-container" class="col-md-4 form-group"></div>
                <div id="name-container" class="col-md-4 form-group"></div>
                {% if customer_form.director %}
                <div id="director-container" class="col-md-3 form-group" style="display:none;">
                    <label>დირექტორი</label>
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text"><i class="fas fa-user-tie"></i></span>
                        </div>
                        <input class="form-control" id="director" name="director" required type="text">
                    </div>
                    {% if customer_form.director.errors %}
                    <div class="text-danger">
                        {% for error in customer_form.director.errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <div id="director-container" class="col-md-3 form-group" style="display:none;"></div>
                {% endif %}
            </div>

            <!-- Remaining fields remain unchanged -->
            <div class="form-row">
                <div class="col-md-4 form-group">
                    <label>ელ. ფოსტა</label>
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                        </div>
                        {{ customer_form.email(class="form-control", id="email", value=existing_customer.email if existing_customer else '') }}
                    </div>
                    {% if customer_form.email.errors %}
                    <div class="text-danger">
                        {% for error in customer_form.email.errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <div class="col-md-4 form-group">
                    <label>მობილური ნომერი</label>
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text"><i class="fas fa-mobile"></i></span>
                        </div>
                        {{ customer_form.mobile(class="form-control", id="mobile", value=existing_customer.mobile if existing_customer else '') }}
                    </div>
                    {% if customer_form.mobile.errors %}
                    <div class="text-danger">
                        {% for error in customer_form.mobile.errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <div class="col-md-4 form-group">
                    <label>დამატებითი საკონტაქტო</label>
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text"><i class="fas fa-phone"></i></span>
                        </div>
                        {{ customer_form.mobile_second(class="form-control", id="mobile_second", value=existing_customer.mobile_second if existing_customer else '') }}
                    </div>
                    {% if customer_form.mobile_second.errors %}
                    <div class="text-danger">
                        {% for error in customer_form.mobile_second.errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Now district, settlement, street etc. remain unchanged -->
            <div class="form-row">
                <div class="col-md-4 form-group">
                    <label>რაიონი</label>
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text"><i class="fas fa-globe-africa"></i></span>
                        </div>
                        {{ order_form.address.district_id(class="form-control", required=True, id="district-select") }}
                    </div>
                </div>

                <div class="col-md-4 form-group">
                    <label>დასახლება</label>
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text"><i class="fas fa-city"></i></span>
                        </div>
                        {{ order_form.address.settlement_id(class="form-control", required=True, id="settlement-select") }}
                    </div>
                    {% if order_form.address.settlement_id.errors %}
                    <div class="text-danger">
                        {% for error in order_form.address.settlement_id.errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <div class="col-md-4 form-group">
                    <label>ქუჩის სახელი</label>
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text"><i class="fas fa-road"></i></span>
                        </div>
                        {{ order_form.address.street(class="form-control", required=True) }}
                    </div>
                    {% if order_form.address.street.errors %}
                    <div class="text-danger">
                        {% for error in order_form.address.street.errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- The rest of the code remains unchanged -->
            <div class="form-row">
                <div class="col-md-4 form-group">
                    <label>შენობის ტიპი</label>
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text"><i class="fas fa-building"></i></span>
                        </div>
                        {{ order_form.address.building_type_id(class="form-control", id="building_type_id", required=True) }}
                    </div>
                    {% if order_form.address.building_type_id.errors %}
                    <div class="text-danger">
                        {% for error in order_form.address.building_type_id.errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="form-row" id="dynamic_fields"></div>

            <div class="form-row">
                <div class="col-md-6 form-group">
                    <label>მობილური ტელეფონი</label>
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text"><i class="fas fa-mobile-alt"></i></span>
                        </div>
                        {{ order_form.mobile(class="form-control", required=True) }}
                    </div>
                    {% if order_form.mobile.errors %}
                    <div class="text-danger">
                        {% for error in order_form.mobile.errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                <div class="col-md-6 form-group">
                    <label>ალტერნატიული მობილური</label>
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text"><i class="fas fa-phone-square-alt"></i></span>
                        </div>
                        {{ order_form.alt_mobile(class="form-control") }}
                    </div>
                    {% if order_form.alt_mobile.errors %}
                    <div class="text-danger">
                        {% for error in order_form.alt_mobile.errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="form-row">
                <div class="col-md-6 form-group">
                    <label>გრძედი</label>
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                        </div>
                        {{ order_form.address.latitude(class="form-control") }}
                    </div>
                </div>
                <div class="col-md-6 form-group">
                    <label>განედი</label>
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                        </div>
                        {{ order_form.address.longitude(class="form-control", required=True) }}
                    </div>
                </div>
            </div>

            <div class="form-row">
                <div class="col-md-6 form-group">
                    <label>შენობის რეგ. კოდი <span class="small">(საკანდასტრო კოდი)</span></label>
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text"><i class="fas fa-building"></i></span>
                        </div>
                        {{ order_form.address.registry_code(class="form-control", required=True, id="registry_code") }}
                    </div>
                    {% if order_form.address.registry_code.errors %}
                    <div class="text-danger">{{ order_form.address.registry_code.errors[0] }}</div>
                    {% endif %}
                </div>
                <div class="col-md-6 form-group">
                    <label>სატარიფო გეგმა</label>
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text"><i class="fas fa-building"></i></span>
                        </div>
                        {{ order_form.tariff_plan_id(class="form-control", required=True, id="tariff_plan_id") }}
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>დამატებითი კომენტარი</label>
                {{ order_form.comment(class="form-control", required=True, rows=5) }}
            </div>

            <div class="text-center mt-3">
                <button type="submit" id="register-button" class="btn btn-primary btn-custom">რეგისტრაცია</button>
            </div>
        </div>
    </div>
</form>
{% endblock %}
